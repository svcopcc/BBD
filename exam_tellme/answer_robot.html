<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>問答解析搜尋器</title>
	<!-- 新版 favicon (SVG) -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    
    <!-- 備用 favicon (PNG/ICO) 給不支援的瀏覽器 -->
    <link rel="alternate icon" type="image/x-icon" href="/favicon.ico">
	
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .correct-answer {
            /* 標示正確答案的樣式，使用黃色背景和粗體 */
            background-color: #fcd34d;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 9999px;
            display: inline-block;
        }
    </style>
    <!-- 引入 PDF.js 函式庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // 設定 PDF.js worker 的路徑
        pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    </script>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-4xl mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-lg">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">PDF 問答解析搜尋器 V. 1.1</h1>
        <p class="text-gray-600 text-center mb-8">
            程式將自動讀取指定的 PDF 檔案，並允許您搜尋題目。
        </p>

        <!-- 主題選擇區塊 (顯示上傳的檔案名稱) -->
        <div class="mb-6">
            <label for="topic-select" class="block text-gray-700 font-semibold mb-2">已讀取檔案：</label>
            <select id="topic-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm bg-gray-50 cursor-not-allowed">
                <option value="https://feixu.tw/BBD/doc57/114%E5%B9%B4%E5%BA%A6%E8%B3%87%E5%AE%89%E5%8F%8A%E5%80%8B%E8%B3%87%E4%BF%9D%E8%AD%B7%E5%AE%A3%E5%80%8B.pdf">114年度資安及個資保護宣導</option>
            </select>
        </div>

        <!-- 搜尋輸入框 -->
        <div class="mb-8">
            <label for="search-input" class="block text-gray-700 font-semibold mb-2">請輸入關鍵字來搜尋題目：</label>
            <input type="text" id="search-input" placeholder="例如：硬碟、個資" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300" disabled>
        </div>

        <!-- 顯示搜尋結果的區塊 -->
        <div id="quiz-container" class="space-y-8">
            <!-- 搜尋結果將動態載入至此 -->
        </div>

        <!-- 狀態與錯誤訊息 -->
        <div id="status-message" class="mt-8 text-center text-red-500 font-semibold">正在讀取檔案...</div>
    </div>

    <script>
        const topicSelect = document.getElementById('topic-select');
        const searchInput = document.getElementById('search-input');
        const quizContainer = document.getElementById('quiz-container');
        const statusMessage = document.getElementById('status-message');

        let quizData = [];

        // 監聽頁面載入事件，自動下載並解析 PDF
        document.addEventListener('DOMContentLoaded', async () => {
            const url = topicSelect.value;
            statusMessage.textContent = '正在解析檔案，請稍候...';
            searchInput.disabled = true;

            try {
                // 使用 fetch 請求指定的 PDF 網址
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP 錯誤! 狀態碼: ${response.status}`);
                }
                const arrayBuffer = await response.arrayBuffer();
                
                // 解析 PDF 檔案
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const questions = await parsePdfQuestions(pdf);
                
                if (questions.length === 0) {
                    statusMessage.textContent = '找不到任何問答題目。請確認檔案格式是否正確。';
                    return;
                }
                
                quizData = questions;
                statusMessage.textContent = `成功讀取 ${questions.length} 個題目！`;
                searchInput.disabled = false;
                
                // 初始顯示所有題目
                filterQuiz();
            } catch (error) {
                statusMessage.textContent = `讀取檔案失敗：${error.message}。請確認網址正確且沒有跨來源（CORS）限制。`;
            }
        });

        // 解析 PDF 並提取問答
        async function parsePdfQuestions(pdf) {
            const questions = [];
            const numPages = pdf.numPages;

            for (let i = 1; i <= numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const textItems = textContent.items;

                // 根據文本內容的座標，將其組合回完整的行
                const lines = groupTextItemsIntoLines(textItems);

                let currentQuestion = null;
                for (const line of lines) {
                    const text = line.text.trim();

                    // 檢查是否為新題目
                    // 根據使用者提供的檔案格式，題目通常以「請問」或「下列」開頭，且結尾有「?」、「？」或「:」
                    if (isQuestionLine(text)) {
                        if (currentQuestion) {
                            questions.push(currentQuestion);
                        }
                        currentQuestion = {
                            question: text,
                            options: [],
                            answerIndex: -1,
                        };
                    } 
                    // 檢查是否為選項
                    else if (isOptionLine(text)) {
                        if (currentQuestion) {
                            currentQuestion.options.push(text);
                        }
                    }
                    // 檢查是否為正確答案標記
                    else if (text.includes('正解')) {
                        // 找到 "正解" 後，將下一個選項標示為答案
                        const lastOptionIndex = currentQuestion.options.length - 1;
                        if (currentQuestion && lastOptionIndex !== -1) {
                            currentQuestion.answerIndex = lastOptionIndex;
                        }
                    }
                }
                if (currentQuestion) {
                    questions.push(currentQuestion);
                }
            }
            return questions;
        }

        // 判斷是否為題目行
        function isQuestionLine(text) {
            return /請問|下列何者|下列個人終端設備防護措施/.test(text) && /[?？:：]/.test(text.slice(-5));
        }

        // 判斷是否為選項行 (A. B. C. D.)
        function isOptionLine(text) {
            return /^[A-Z][.、)]\s/.test(text);
        }

        // 將 PDF.js 的文本項目根據垂直座標分組為行
        function groupTextItemsIntoLines(items) {
            const lines = [];
            let lastY = -1;
            let currentLine = { text: '', y: -1, items: [] };

            for (const item of items) {
                if (Math.abs(item.transform[5] - lastY) > 5) { // 垂直距離超過一個閾值，視為新行
                    if (currentLine.items.length > 0) {
                        lines.push(currentLine);
                    }
                    currentLine = { text: '', y: item.transform[5], items: [] };
                }
                currentLine.items.push(item);
                lastY = item.transform[5];
            }
            if (currentLine.items.length > 0) {
                lines.push(currentLine);
            }
            
            // 將每一行的項目組合為單一字串
            return lines.map(line => ({
                text: line.items.map(item => item.str).join(' '),
                y: line.y
            }));
        }

        // 根據輸入框內容篩選題目
        function filterQuiz() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const filteredData = quizData.filter(quiz => {
                return quiz.question.toLowerCase().includes(searchTerm);
            });
            renderQuiz(filteredData);
        }

        // 渲染題目到頁面
        function renderQuiz(data) {
            quizContainer.innerHTML = ''; // 清空舊的內容
            if (data.length === 0) {
                quizContainer.innerHTML = '<p class="text-center text-gray-500">找不到相符的題目。</p>';
                return;
            }

            data.forEach((quiz, index) => {
                const quizItem = document.createElement('div');
                quizItem.className = 'bg-gray-100 p-6 rounded-lg shadow-sm';
                
                let optionsHtml = '';
                const optionLabels = ['A', 'B', 'C', 'D'];
                quiz.options.forEach((option, i) => {
                    const isCorrect = i === quiz.answerIndex;
                    const optionClass = isCorrect ? 'text-gray-800 correct-answer' : 'text-gray-600';
                    optionsHtml += `
                        <li class="mb-2">
                            <span class="${optionClass}">${option}</span>
                        </li>
                    `;
                });

                quizItem.innerHTML = `
                    <p class="text-lg font-bold text-gray-800 mb-4">
                        Q${index + 1}. ${quiz.question}
                    </p>
                    <ul class="list-none space-y-2">
                        ${optionsHtml}
                    </ul>
                `;
                quizContainer.appendChild(quizItem);
            });
        }
        
        // 事件監聽
        searchInput.addEventListener('input', filterQuiz);
    </script>
</body>
</html>
