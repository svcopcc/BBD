<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<!-- PDF.js ESM（使用本地檔） -->
	<script type="module">
	  import * as pdfjsLib from "./pdf.min.mjs";
	  // 指定本地 worker（與本檔同資料夾）
	  pdfjsLib.GlobalWorkerOptions.workerSrc = "./pdf.worker.min.mjs";
	  // 讓底部的非 module <script> 也能用到 pdfjsLib
	  window.pdfjsLib = pdfjsLib;
	</script>


    <title>多主題問答搜尋器</title>
	<!-- 新版 favicon (SVG) -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    
    <!-- 備用 favicon (PNG/ICO) 給不支援的瀏覽器 -->
    <link rel="alternate icon" type="image/x-icon" href="/favicon.ico">
	
	
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .correct-answer {
            /* 標示正確答案的樣式，使用黃色背景和粗體 */
            background-color: #fcd34d;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 9999px;
            display: inline-block;
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-4xl mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-lg">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">多主題問答搜尋器</h1>
        <p class="text-gray-600 text-center mb-8">
            從下拉選單中選擇一個主題，然後使用下方的搜尋欄位來尋找您想了解的題目。
        </p>

		<!-- PDF 載入區 -->
		<div class="mb-6 grid gap-3 sm:grid-cols-3">
		  <div class="sm:col-span-2">
			<label class="block text-gray-700 font-semibold mb-2">PDF 網址：</label>
			<input id="pdf-url" type="url" placeholder="http://...（填入 PDF 連結）"
				   class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
			<p class="text-xs text-gray-500 mt-1">若跨網域被擋，請用下方「本機選檔」。</p>
		  </div>
		  <div>
			<label class="block text-gray-700 font-semibold mb-2">或選擇本機 PDF：</label>
			<input id="pdf-file" type="file" accept="application/pdf"
				   class="w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4
						  file:rounded-lg file:border-0 file:text-sm file:font-semibold
						  file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
		  </div>
		  <div class="sm:col-span-3">
			<button id="load-pdf" class="w-full py-2 px-4 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700">
			  讀取 PDF
			</button>
		  </div>
		</div>


        <!-- 主題選擇區塊 -->
        <div class="mb-6">
            <label for="topic-select" class="block text-gray-700 font-semibold mb-2">請選擇題目主題：</label>
            <select id="topic-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
                <option value="114_資安宣導">114年度資安及個資保護宣導</option>
                <option value="其他主題範例">其他主題範例 (請替換)</option>
            </select>
        </div>

        <!-- 搜尋輸入框 -->
        <div class="mb-8">
            <label for="search-input" class="block text-gray-700 font-semibold mb-2">請輸入關鍵字來搜尋題目：</label>
            <input type="text" id="search-input" placeholder="例如：硬碟、個資" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
        </div>
		
		<!-- 搜尋按鈕 -->
		<div class="mt-4 flex space-x-2">
		  <input id="search-input" type="text"
				 placeholder="輸入關鍵字搜尋題目"
				 class="flex-1 px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
		  <button id="search-btn"
				  class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
			搜尋
		  </button>
		</div>


        <!-- 顯示搜尋結果的區塊 -->
        <div id="quiz-container" class="space-y-8">
            <!-- 搜尋結果將動態載入至此 -->
        </div>
    </div>

    <script>
	document.addEventListener('DOMContentLoaded', () => {
	  const searchInput   = document.getElementById('search-input');
	  const quizContainer = document.getElementById('quiz-container');

	  const pdfUrlInput = document.getElementById('pdf-url');
	  const pdfFileInput = document.getElementById('pdf-file');
	  const loadBtn = document.getElementById('load-pdf');

	  // ====== 偵測參數（針對你題目圖示在左邊的情況） ======
	  const DETECT = {
		leftMaxPx: 60,
		leftMinPx: 12,
		yPadPx: 14,
		gridStepX: 6,
		gridStepY: 6,
		hitNeeded: 10,
		yellow: {
		  rMin: 200, gMin: 160, bMax: 110,
		  rgDiffMin: 20, minAlpha: 10
		}
	  };

	  let quizData = [];

	  // 渲染題目
	  function renderQuiz(data) {
		quizContainer.innerHTML = '';
		if (!data || data.length === 0) {
		  quizContainer.innerHTML = '<p class="text-center text-gray-500">找不到相符的題目。</p>';
		  return;
		}
		data.forEach((quiz, idx) => {
		  const item = document.createElement('div');
		  item.className = 'bg-gray-100 p-6 rounded-lg shadow-sm';
		  let html = `<p class="text-lg font-bold text-gray-800 mb-4">Q${idx+1}. ${quiz.question}</p><ul class="list-none space-y-2">`;
		  const labs = ['A','B','C','D','E','F'];
		  quiz.options.forEach((opt, i) => {
			const isCorrect = i === quiz.answerIndex;
			html += `<li class="mb-2"><span class="${isCorrect?'correct-answer':'text-gray-600'}">${labs[i]??''}、${opt}</span></li>`;
		  });
		  html += `</ul>`;
		  item.innerHTML = html;
		  quizContainer.appendChild(item);
		});
	  }

	  // 搜尋功能
	  function filterQuiz() {
		const term = (searchInput.value||'').toLowerCase();
		if (!term) { renderQuiz(quizData); return; }
		const filtered = quizData.filter(q => q.question.toLowerCase().includes(term));
		renderQuiz(filtered);
	  }
	  searchInput.addEventListener('input', filterQuiz);
	  
	  //搜尋功能按鈕
	  const searchBtn = document.getElementById('search-btn');
	  searchBtn.addEventListener('click', filterQuiz);


	  // 載入 PDF
	  loadBtn.addEventListener('click', async () => {
		try {
		  let buf = null;
		  if (pdfFileInput.files && pdfFileInput.files[0]) {
			buf = await pdfFileInput.files[0].arrayBuffer();
		  } else {
			const url = (pdfUrlInput.value||'').trim();
			if (!url) { alert('請輸入 PDF 網址或選擇檔案'); return; }
			const res = await fetch(url, {mode:'cors'});
			buf = await res.arrayBuffer();
		  }
		  quizContainer.innerHTML = '<p class="text-center text-gray-500">解析中，請稍候…</p>';
		  quizData = await parsePdfToQuiz(buf);
		  renderQuiz(quizData);
		} catch(e) {
		  console.error(e);
		  alert('PDF 載入失敗：'+e.message);
		}
	  });

	  // PDF 解析
	  async function parsePdfToQuiz(arrayBuffer) {
		const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
		const out = [];
		for (let n=1;n<=pdf.numPages;n++) {
		  const page = await pdf.getPage(n);
		  const textContent = await page.getTextContent();
		  const viewport = page.getViewport({scale:2});
		  const canvas = document.createElement('canvas');
		  const ctx = canvas.getContext('2d',{willReadFrequently:true});
		  canvas.width = viewport.width; canvas.height = viewport.height;
		  await page.render({canvasContext:ctx, viewport}).promise;

		  const lines = textItemsToLines(textContent.items, viewport);
		  for (let i=0;i<lines.length;i++) {
			const q = lines[i].text.trim();
			if (isQuestionLine(q)) {
			  const opts=[], boxes=[];
			  let j=i+1;
			  while (j<lines.length && isOptionLine(lines[j].text)) {
				opts.push(lines[j].text.replace(/^\s*[A-F][、\.\)]\s*/,'').trim());
				boxes.push(lines[j].bbox);
				j++;
			  }
			  if (opts.length>=2) {
				const ans = detectYellowAnswerIndex(ctx, boxes, DETECT);
				out.push({question:q, options:opts, answerIndex:(ans??-1)});
				i=j-1;
			  }
			}
		  }
		}
		return out;
	  }

	  function textItemsToLines(items, viewport){
		const rows=[];
		for (const it of items){
		  const x=it.transform[4], y=it.transform[5];
		  const h=Math.abs(it.transform[3]);
		  const w=(it.width?it.width*viewport.scale:it.str.length*h*0.6);
		  rows.push({text:it.str, x, y, w, h});
		}
		rows.sort((a,b)=>b.y-a.y);
		const lines=[], tol=2.5;
		for (const r of rows){
		  let found=false;
		  for (const L of lines){
			if (Math.abs(L.y-r.y)<=tol){ L.segs.push(r); L.y=(L.y+r.y)/2; found=true; break;}
		  }
		  if (!found) lines.push({y:r.y, segs:[r]});
		}
		return lines.map(L=>{
		  L.segs.sort((a,b)=>a.x-b.x);
		  const txt=L.segs.map(s=>s.text).join('');
		  const x0=Math.min(...L.segs.map(s=>s.x));
		  const y0=Math.min(...L.segs.map(s=>s.y-s.h));
		  const x1=Math.max(...L.segs.map(s=>s.x+s.w));
		  const y1=Math.max(...L.segs.map(s=>s.y));
		  return {text:txt.trim(), bbox:{x:x0,y:y0,w:(x1-x0),h:(y1-y0)}};
		}).filter(l=>l.text);
	  }

	  function isQuestionLine(t){return /[？\?:]\s*$/.test(t)||/請問|下列何者/.test(t);}
	  function isOptionLine(t){return /^[A-F][、\.\)]/.test(t);}

	  function detectYellowAnswerIndex(ctx, boxes, cfg){
		let winner=null;
		for (let i=0;i<boxes.length;i++){
		  const b=boxes[i];
		  const xStart=Math.max(b.x-cfg.leftMaxPx,0);
		  const xEnd=Math.max(b.x-cfg.leftMinPx,0);
		  const cy=b.y+b.h/2;
		  const yStart=Math.max(cy-cfg.yPadPx,0);
		  const yEnd=Math.max(cy+cfg.yPadPx,0);
		  let hits=0;
		  for (let y=yStart;y<=yEnd;y+=cfg.gridStepY){
			for (let x=xStart;x<=xEnd;x+=cfg.gridStepX){
			  const d=ctx.getImageData(x,y,1,1).data;
			  if (d[3]>=cfg.yellow.minAlpha &&
				  d[0]>=cfg.yellow.rMin && d[1]>=cfg.yellow.gMin &&
				  d[2]<=cfg.yellow.bMax &&
				  Math.abs(d[0]-d[1])>=cfg.yellow.rgDiffMin){
				hits++;
				if (hits>=cfg.hitNeeded){winner=i;break;}
			  }
			}
			if (winner!==null) break;
		  }
		  if (winner!==null) break;
		}
		return winner;
	  }

	  quizContainer.innerHTML='<p class="text-center text-gray-500">請先載入 PDF。</p>';
	});
	</script>

</body>
</html>
